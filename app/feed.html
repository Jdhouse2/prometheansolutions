<!DOCTYPE html>
<html>
    <head>
            <meta charset='UTF-8'>
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Rent-A-Item</title>
            <link rel='stylesheet' href='./css/nav.css' type='text/css'>
            <link rel='stylesheet' href='./css/main.css' type='text/css'>
            <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet">
            <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
            <script src='./js/feed.js'></script>
            <script src='./js/main.js'></script>
    </head>
    <body>
        <div id='nav'>

        </div>
        <div class='feedContainer flex flex-row'>
            <div class='leftNavbar'>

            </div>
            <div class='listContainer'>

            </div>

        </div>
        <script>
            let feedState = {
                items: [],
                itemsObject: {},
                activeId: null,
            }

            function getItems() {
                $.ajax({
                    type: "GET",
                    url: '/api/get-items',
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function (msg) {
                        feedState.items = msg;

                        feedState.items.forEach((item) => {
                            feedState.itemsObject[item.item_id] = {
                                name: item.item_name,
                                category: item.item_category,
                                zip: item.item_zipcode,
                                desc: item.item_description,
                                price: item.day_price,
                                available: item.available,
                            }    
                        });
                    },
                    error: function (e) {
                        console.log('failure')
                        console.log(e)
                    }
                }).done((msg) => {
                    msg.forEach((item) => {
                        console.log(feedState)
                        addToUi(item)
                    })
                })
            }

            function determineHref(category){
                switch(category){
                    case 'toys':
                        return './assets/puzzle.png'
                    case 'Toys':
                        return './assets/puzzle.png'
                    case 'Cooking':
                        return './assets/chef.png'
                    case 'Electronics':
                        return './assets/pc.png'
                    case 'Home Improvement':
                        return './assets/hammer.png'
                    case 'Gardening':
                        return './assets/shovel.png'
                    case 'Sports':
                        return './assets/football.png'
                }
            }

            function rotate(id){
                let targetToRotate = document.getElementById(`${id}`)
                console.log(id)
                console.log(targetToRotate)
                let chevron = document.getElementById(`${id}Chevron`)
                
                if(targetToRotate.classList.contains('active')){
                    targetToRotate.classList.remove('active')
                    chevron.classList.remove('rotate')
                } else {
                    targetToRotate.classList.add('active')
                    chevron.classList.add('rotate')
                }
            }

            function addToUi(itemObj){
                let listContainer = document.querySelector('.listContainer')
                let itemContainer = generateFlexbox()
                    itemContainer.classList.add('item-container')
                    itemContainer.id = itemObj.item_id
                let imgHref = determineHref(itemObj.item_category)

                let picture = generateDiv(`<img src=${imgHref} />`, ['item-img'])

                let details = generateFlexbox()
                    details.classList.add('item-details')
                    details.innerHTML = itemObj.item_name
                
                let dropdownIcon = document.createElement('div');
                    dropdownIcon.classList.add('dropdown-icon')
                    dropdownIcon.id = `${itemObj.item_id}Chevron`

                itemContainer.appendChild(picture)
                itemContainer.appendChild(details)
                itemContainer.appendChild(dropdownIcon)
                listContainer.appendChild(itemContainer)

                dropdownIcon.addEventListener('click', (e) => {
                    let targetId = e.target.id.split('C', 1)[0]

                    if(feedState.activeId === targetId){
                        rotate(targetId)
                        feedState.activeId = null
                    } else if (feedState.activeId !== targetId && feedState.activeId !== null) {
                        rotate(feedState.activeId)
                        rotate(targetId)
                        feedState.activeId = targetId
                    } else if (feedState.activeId === null){
                        rotate(targetId)
                        feedState.activeId = targetId
                    }
                })

            }
            
            function initFeed() {
                getItems()
            }

            init()
            initFeed()
        </script>
    </body>
</html>